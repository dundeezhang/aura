<!DOCTYPE html>

{% extends 'base.html' %} {% block head %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/email.css') }}"
/>
{% endblock %} {% block body %}

<h1>Email Generator</h1>

<div id="generated-post-container">
    {% if result %}
    <h1>Generated Email:</h1>
    <p>Note that this is generated in plain text.</p>
    <div id="generated-post">{{ result }}</div>

    <button id="copy-button">Copy Email</button>
    {% endif %}
</div>

<div id="form-container">
    <form method="POST" id="email-form">
        <label for="name">Your Name:</label>
        <input type="text" id="name" name="name" required />

        <label for="tone">Tone:</label>
        <select id="tone" name="tone" required>
            <option value="formal">Formal</option>
            <option value="informal">Informal</option>
            <option value="friendly">Friendly</option>
            <option value="Aggressive">Aggressive</option>
        </select>

        <label for="old-email">Email you are replying to:</label>
        <textarea id="old-email" name="old-email" rows="4" required></textarea>

        <div class="button">
            <button type="submit" id="generate-button">Generate Email</button>
        </div>
    </form>
</div>

<div id="generating-message" style="display: none">
    Generating... Please wait.
</div>

<script>
    const formContainer = document.getElementById("form-container");
    const generatingMessage = document.getElementById("generating-message");
    const emailForm = document.getElementById("email-form");
    const generateButton = document.getElementById("generate-button");

    emailForm.addEventListener("submit", function (event) {
        event.preventDefault();

        formContainer.style.display = "none";
        generatingMessage.style.display = "block";

        fetch(emailForm.action, {
            method: emailForm.method,
            body: new FormData(emailForm),
        })
            .then((response) => response.text())
            .then((html) => {
                document.documentElement.innerHTML = html;
                attachCopyButtonListener();
            })
            .catch((error) => {
                console.error("Error:", error);
                generatingMessage.style.display = "none";
                formContainer.style.display = "block";
                alert("An error occurred during email generation.");
            });
    });

    function attachCopyButtonListener() {
        const copyButton = document.getElementById("copy-button");
        const generatedPost = document.getElementById("generated-post");

        if (copyButton && generatedPost) {
            copyButton.addEventListener("click", function () {
                const range = document.createRange();
                range.selectNodeContents(generatedPost);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                navigator.clipboard
                    .writeText(range.toString())
                    .then(() => {
                        copyButton.textContent = "Copied!";
                        setTimeout(() => {
                            copyButton.textContent = "Copy Email";
                        }, 2000);
                    })
                    .catch((err) => {
                        console.error("Failed to copy: ", err);
                        copyButton.textContent = "Copy Failed";
                        setTimeout(() => {
                            copyButton.textContent = "Copy Email";
                        }, 2000);
                    });
                window.getSelection().removeAllRanges();
            });
        }
    }

    attachCopyButtonListener();
</script>

{% endblock %}
